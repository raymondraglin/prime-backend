import os, ast
lines = ['from __future__ import annotations', 'import os', 'from datetime import datetime', 'from typing import Optional', 'from fastapi import APIRouter, Depends, HTTPException, BackgroundTasks', 'from pydantic import BaseModel', 'from sqlalchemy.orm import Session', 'from sqlalchemy import asc', 'from app.database import get_db', 'from app.prime.models import PrimeConversation, PrimeMemory', 'from app.prime.reasoning.endpoints import reasoning_core', 'from app.prime.curriculum.models import (', '    ReasoningTask,', '    ReasoningTaskKind,', '    ReasoningCoreRequest,', '    ReasoningCoreResponse,', ')', '', "router = APIRouter(prefix='/prime/chat', tags=['PRIME Chat'])", '', '', '# ── Schemas ──────────────────────────────────────────────────', '', 'class ChatRequest(BaseModel):', '    message: str', '    session_id: Optional[str] = None', "    domain: str = 'general'", '    subdomain: Optional[str] = None', '    allowed_tools: list[str] = []', '', '', 'class ChatResponse(BaseModel):', '    conversation_id: int', '    session_id: Optional[str]', '    key_conclusions: list[str]', '    open_questions: list[str]', '    step_count: int', '    overall_confidence: float', '    assembled_at: str', '', '', 'class RatingRequest(BaseModel):', '    conversation_id: int', '    rating: str', '    note: Optional[str] = None', '', '', '# ── Storage ──────────────────────────────────────────────────', '', 'def _store(db: Session, speaker: str, message: str,', '           session_id: Optional[str], extra: Optional[dict] = None) -> PrimeConversation:', '    row = PrimeConversation(', '        session_id=session_id,', '        speaker=speaker,', '        message=message,', '        conv_metadata=extra or {},', '    )', '    db.add(row)', '    db.commit()', '    db.refresh(row)', '    return row', '', '', '# ── Endpoints ────────────────────────────────────────────────', '', "@router.post('/', response_model=ChatResponse)", 'async def prime_chat(', '    req: ChatRequest,', '    db: Session = Depends(get_db),', '):', '    if not req.message.strip():', "        raise HTTPException(400, 'Message cannot be empty.')", '', "    raymond_row = _store(db, 'raymond', req.message, req.session_id)", '', '    task = ReasoningTask(', "        task_id='chat-' + raymond_row.id.__str__(),", '        natural_language_task=req.message,', '        desired_output_kind=ReasoningTaskKind.ANALYSIS,', '        domain_tag=req.domain,', '        subdomain_tag=req.subdomain,', '        allowed_tools=req.allowed_tools,', '        given_facts=[],', '        assumptions=[],', '        constraints=[],', '    )', '', '    core_req = ReasoningCoreRequest(task=task, max_steps=12)', '    result: ReasoningCoreResponse = await reasoning_core(core_req)', '', "    summary = ' | '.join(result.key_conclusions[:3]) if result.key_conclusions else req.message", '', '    prime_row = _store(', "        db, 'prime', summary, req.session_id,", '        extra={', "            'key_conclusions': result.key_conclusions,", "            'open_questions':  result.open_questions,", "            'step_count':      len(result.trace.steps),", "            'confidence':      result.trace.overall_confidence,", '        },', '    )', '', '    return ChatResponse(', '        conversation_id=prime_row.id,', '        session_id=req.session_id,', '        key_conclusions=result.key_conclusions,', '        open_questions=result.open_questions,', '        step_count=len(result.trace.steps),', '        overall_confidence=result.trace.overall_confidence,', '        assembled_at=datetime.utcnow().isoformat(),', '    )', '', '', "@router.post('/rate')", 'async def rate_response(', '    req: RatingRequest,', '    db: Session = Depends(get_db),', '):', '    row = db.query(PrimeConversation).filter_by(id=req.conversation_id).first()', '    if not row:', "        raise HTTPException(404, 'Not found.')", "    if row.speaker != 'prime':", "        raise HTTPException(400, 'Can only rate PRIME responses.')", '    row.conv_metadata = {', '        **row.conv_metadata,', "        'rating':      req.rating,", "        'rating_note': req.note,", "        'rated_at':    datetime.utcnow().isoformat(),", '    }', '    db.commit()', "    return {'status': 'rated', 'conversation_id': req.conversation_id, 'rating': req.rating}", '', '', "@router.get('/history')", 'async def get_history(', '    limit: int = 50,', '    offset: int = 0,', '    session_id: Optional[str] = None,', '    db: Session = Depends(get_db),', '):', '    q = db.query(PrimeConversation)', '    if session_id:', '        q = q.filter(PrimeConversation.session_id == session_id)', '    total = q.count()', '    rows = q.order_by(asc(PrimeConversation.created_at)).offset(offset).limit(limit).all()', '    return {', "        'total':  total,", "        'offset': offset,", "        'limit':  limit,", "        'turns': [", '            {', "                'id':         r.id,", "                'speaker':    r.speaker,", "                'message':    r.message,", "                'session_id': r.session_id,", "                'metadata':   r.conv_metadata,", "                'created_at': r.created_at.isoformat(),", '            }', '            for r in rows', '        ],', '    }']
code = '\n'.join(lines) + '\n'
raw = code.encode('utf-8')
assert b'\x00' not in raw
ast.parse(code)
print('Syntax: OK')
os.makedirs('app/prime/api', exist_ok=True)
open('app/prime/api/chat.py', 'wb').write(raw)
check = open('app/prime/api/chat.py', 'rb').read()
print('Null bytes:', check.count(b'\x00'))
print('Written:', len(check), 'bytes')
print('SUCCESS')